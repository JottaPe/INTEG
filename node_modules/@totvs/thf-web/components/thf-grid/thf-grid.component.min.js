var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){t(e,o);function r(){this.constructor=e}e.prototype=null===o?Object.create(o):(r.prototype=o.prototype,new r)}}();import{Component,EventEmitter,Input,Output,ViewChild,ViewContainerRef,ViewEncapsulation,Renderer2}from"@angular/core";import{FormGroup,FormControl,Validators}from"@angular/forms";import{GridComponent}from"@progress/kendo-angular-grid";import{process}from"@progress/kendo-data-query";import{orderBy}from"@progress/kendo-data-query";import{ThfGridBaseComponent}from"@totvs/thf-core/components/thf-grid-base/thf-grid-base.component";var ThfGridComponent=function(t){__extends(e,t);function e(e,o){var r=t.call(this)||this;return r.viewRef=e,r.renderer=o,r.sortable=!1,r.selectable=!1,r.editable=!1,r.groupable=!1,r.exportButtons=!1,r.showMoreDisabled="false",r.showRemoveButton=!1,r.addButton=!1,r.showMore=new EventEmitter,r.selectionChange=new EventEmitter,r.saveValue=new EventEmitter,r.editedRowIndex=-1,r.groups=[],r.state={skip:0},r.sort=[],r.addButtonCalled=!1,r.isCancelling=!1,r._parentRef=e._view.component,r.allData=r.allData.bind(r),r}return e.prototype.ngOnInit=function(){var t=this;if(this.renderer.listen("document","click",function(e){var o=e.target;t.validateSaveEventInDocument(o)}),this.data||(this.data=[]),this.columns?this.defineColumnType():this.columns=[],this.sortable&&(this.sortableObject={allowUnsort:this.sortable,mode:"single"}),this.groupable){for(var e=this.columns.length,o=0;o<e;o++){var r=this.columns[o];this.groups.length<2&&r.groupHeader&&this.groups.push({field:r.column})}this.sortableObject=null,this.loadDataGroupable()}else this.loadData();this.editable||(this.grid=null)},e.prototype.defineColumnType=function(){var t={number:function(t){t.type="numeric",t.format=void 0},currency:function(t){t.type="numeric",t.format="{0:c}"},date:function(t){t.type="date",t.format&&t.format.trim().length>0?t.format="{0:"+t.format+"}":t.format="{0:dd/MM/yyyy}"},string:function(t){t.type="text",t.format=void 0}};this.columns.forEach(function(e){e.type&&t.hasOwnProperty(e.type.trim().toLowerCase())?t[e.type.trim().toLowerCase()](e):e.type="text"})},e.prototype.isChildOf=function(t,e){for(;t&&t.parentElement;){if(this.hasClass(t.parentElement,e))return!0;t=t.parentElement}return!1},e.prototype.hasClass=function(t,e){return new RegExp(e).test(t.className)},e.prototype.validateSaveEventInDocument=function(t){this.isChildOf(t,"k-grid-content")||this.isChildOf(t,"k-grid-toolbar")||this.saveClick()},e.prototype.sortChange=function(t){this.sort=t,this.loadData()},e.prototype.dataStateChange=function(t){t.group.length>2&&t.group.splice(0,1),this.state=t,this.gridView=process(this.data,this.state)},e.prototype.updateIndex=function(t){for(var e=0,o=t.length;e<o;e++)this.data[e]=t[e]},e.prototype.loadData=function(){this.updateIndex(orderBy(this.data,this.sort)),this.gridView={data:this.data,total:this.data.length}},e.prototype.createFormGroup=function(){for(var t={},e=0;e<this.columns.length;e++){var o=this.columns[e];o.checkbox||(o.required?t[o.column]=new FormControl("",Validators.required):t[o.column]=new FormControl(""))}this.formGroup=new FormGroup(t)},e.prototype.addHandler=function(t){var e=t.sender;if(this.editedRowIndex>=0&&this.closeEditor(e,this.editedRowIndex),this.addButtonCalled=!0,this.createFormGroup(),this.addAction){if(!this.executeFunctionValidation(this.addAction,this.formGroup.value))return;this.formGroup.setValue(this.formGroup.value)}e.addRow(this.formGroup)},e.prototype.executeFunctionValidation=function(t,e){return t&&this._parentRef[t](e)},e.prototype.saveLine=function(){if(this.editable){var t=void 0;this.editedRowIndex>=0?(t=Object.assign(this.data[this.editedRowIndex],this.formGroup.value),this.data[this.editedRowIndex]=t):this.addButtonCalled&&this.formGroup&&(t=this.formGroup.value,this.data.push(t),this.addButtonCalled=!1),this.isGroup()&&this.loadDataGroupable(),this.saveValue.emit({data:t})}},e.prototype.editClickHandler=function(t){var e=t.rowIndex,o=t.dataItem;this.isValidForm()||(this.executeFunctionValidation(this.saveAction,{data:this.data[this.editedRowIndex]})&&this.saveLine(),this.isGroup()&&(e=this.getRowIndex(this.data,o)),this.editHandler({sender:this.grid,rowIndex:e,dataItem:o}))},e.prototype.getRowIndex=function(t,e){for(var o=Object.keys(e),r=0;r<t.length;r++){for(var n=!0,i=0,a=o;i<a.length;i++){var d=a[i];if(t[r][d]!==e[d]){n=!1;break}}if(n)return r}return-1},e.prototype.editHandler=function(t){var e=t.sender,o=t.rowIndex,r=t.dataItem;if(this.editable){this.closeEditor(e),this.editedProducted=Object.assign({},r),this.formGroup=new FormGroup({});for(var n=0,i=Object.keys(r);n<i.length;n++){var a=i[n],d=void 0,s=this.getColumn(a);s&&s.editable&&(d=s.required?new FormControl(r[a],Validators.required):new FormControl(r[a]),this.formGroup.addControl(a,d))}this.editedRowIndex=o,e.editRow(o,this.formGroup)}},e.prototype.saveClick=function(){if(this.addButtonCalled&&this.saveAction&&this.formGroup){if(!this.executeFunctionValidation(this.saveAction,{data:this.formGroup.value}))return}else if(this.editedRowIndex>=0&&this.saveAction&&!this.executeFunctionValidation(this.saveAction,{data:this.data[this.editedRowIndex]}))return void this.closeEditor(this.grid,this.editedRowIndex);this.isValidForm()||(this.saveLine(),this.closeEditor(this.grid),this.isGroup()?this.loadDataGroupable():this.loadData())},e.prototype.isGroup=function(){return this.groups&&this.groups.length>0},e.prototype.getColumn=function(t){for(var e=0;e<this.columns.length;e++){var o=this.columns[e];if(o.column===t)return o}},e.prototype.closeEditor=function(t,e){e=this.editedRowIndex,t&&t.closeRow(e),this.editedRowIndex=void 0,this.formGroup=void 0},e.prototype.saveHandler=function(t){var e=t.sender,o=t.rowIndex,r=t.formGroup,n=t.isNew,i=r.value;n&&!this.editable?this.data.push(i):this.data[o]=Object.assign(this.data[o],i),this.isGroup()?this.loadDataGroupable():this.loadData(),e.closeRow(o)},e.prototype.cancelPropagation=function(t){t.stopPropagation()},e.prototype.cancelHandler=function(t){var e=t.sender,o=t.rowIndex;null!=this.editedProducted&&(this.data[o]=this.editedProducted,this.editedProducted=null),this.isGroup()?this.loadDataGroupable():this.loadData(),this.closeEditor(e)},e.prototype.removeHandler=function(t){var e=t.rowIndex;this.removeAction&&!this.executeFunctionValidation(this.removeAction,{data:this.data[e]})||(this.data.splice(e,1),this.groupable?this.loadDataGroupable():this.loadData())},e.prototype.isValidForm=function(){return this.formGroup&&!this.formGroup.valid},e.prototype.allData=function(){return{data:process(this.data,{}).data}},e.prototype.changeValueCheckbox=function(t,e,o,r){this.editable?(o[r]=t.target.checked,this.data[e]=Object.assign(o),this.saveValue.emit({data:this.data[e]})):t.target.checked=!t.target.checked},e.prototype.onSelectionChange=function(t){this.selectionChange.emit({data:this.gridView.data[t.index]})},e.prototype.onShowMore=function(){this.showMore.emit(null),this.groupable?this.loadDataGroupable():this.loadData()},e.prototype.groupChange=function(t){this.groups=t,this.loadDataGroupable()},e.prototype.loadDataGroupable=function(){this.gridView=process(this.data,{group:this.groups}),this.dataArrayOrdered=[],this.getObjects(this.gridView.data),this.updateIndex(this.dataArrayOrdered)},e.prototype.getObjects=function(t){var e=this;t.forEach(function(t){t.items instanceof Array?e.getObjects(t.items):e.dataArrayOrdered.push(t)})},e.decorators=[{type:Component,args:[{selector:"thf-grid",encapsulation:ViewEncapsulation.None,template:'<kendo-grid  [data]="gridView"  [sortable]="sortableObject" [sort]="sort" [groupable]="groupable" [group]="groups" [selectable]="selectable" (dataStateChange)="dataStateChange($event)" (groupChange)="groupChange($event)" (selectionChange)="onSelectionChange($event)" (sortChange)="sortChange($event)" (add)="addHandler($event)" (cancel)="cancelHandler($event)" (cellClick)="editClickHandler($event)" (edit)="editHandler($event)" (remove)="removeHandler($event)" (save)="saveHandler($event)" style="height: 70%"> <kendo-grid-messages  i18n-noRecords="" noRecords="Não há registros" i18n-groupPanelEmpty="" groupPanelEmpty="Arraste a coluna até o cabeçalho e solte para agrupar por esta coluna"> </kendo-grid-messages> <ng-template kendoGridToolbarTemplate *ngIf="addButton || exportButtons" > <button kendoGridAddCommand *ngIf="addButton" class="k-primary">Adicionar</button> <button type="button" kendoGridExcelCommand *ngIf="exportButtons" ><span class="k-icon k-i-file-excel"></span></button> <button kendoGridPDFCommand *ngIf="exportButtons"><span class=\'k-icon k-i-file-pdf\'></span></button> </ng-template> <kendo-grid-column *ngFor="let col of columns; let i = index" [field]="col.column" [title]="col.label" [width]="col.width" [filter]="col.filter" [format]="col.format" [editor]="col.type"> <ng-template kendoGridCellTemplate let-data *ngIf="col.checkbox" let-rowIndex="rowIndex"> <input type="checkbox" id="chkbox_{{rowIndex}}" name="chkbox_{{col.column}}_{{rowIndex}}" [checked]="data[col.column]" (change)="changeValueCheckbox($event, rowIndex, data, col.column)" class="thf-grid thf-grid-checkbox" /> <label for="chkbox_{{rowIndex}}"></label> </ng-template> <ng-template kendoGridGroupHeaderTemplate let-value="value" *ngIf="col.groupHeader"> {{value}} </ng-template> </kendo-grid-column> <kendo-grid-command-column title="" width="80"> <ng-template kendoGridCellTemplate let-isNew="isNew"> <button kendoGridRemoveCommand class="k-primary" *ngIf="showRemoveButton" >Remover</button> <button kendoGridCancelCommand class="k-primary" (click)="cancelPropagation($event)">{{ isNew ? \'Descartar\' : \'Cancelar\' }} </button> </ng-template> </kendo-grid-command-column> <kendo-grid-excel fileName="spreadsheet.xlsx" [fetchData]="allData"></kendo-grid-excel> <kendo-grid-pdf fileName="grid.pdf" [allPages]="true"> <kendo-grid-pdf-margin top="1cm" left="1cm" right="1cm" bottom="1cm"></kendo-grid-pdf-margin> </kendo-grid-pdf> </kendo-grid> <div class="thf-grid-show-more" *ngIf="showMore.observers.length > 0"> <div style="text-align: center;"> <thf-button t-label="Carregar mais resultados" (t-click)="onShowMore()" t-id="btnShowMoreId" [t-disabled]="showMoreDisabled"></thf-button> </div> </div> ',styles:[".k-grid .k-state-selected { background-color: skyblue !important; color: #000000; } .k-grid .k-alt.k-state-selected { background-color: skyblue !important; color: #000000; } .thf-grid.thf-grid-checkbox { width: 20px; height: 20px; border-radius: 2px; box-shadow: inset 0 1px 8px 0 rgba(0, 0, 0, 0.1); border: solid 1px rgba(255, 255, 255, 0.6); } .thf-grid.thf-grid-checkbox:checked { width: 20px; height: 20px; border-radius: 2px; } input[type=checkbox] { visibility: hidden; position: absolute; } input[type=checkbox] + label:before { width: 20px; height: 20px; margin-top: -2px; margin-right: 8px; display: inline-block; vertical-align: middle; background-color: #ffffff; box-shadow: inset 0px 2px 8px 0 #edefef; border: solid 1px #b7bebf; content: ' '; } input[type=checkbox]:checked + label:before { background-color: #0c9abe; box-shadow: none; color: white; font-family: 'TotvsIcon' !important; line-height: 18px; content: '\\e937'; padding-left: 1px; } input[type=checkbox]:disabled + label:before { background-color: #edefef; border: solid 1px #b7bebf; } input[type=checkbox]:checked:disabled + label:before { color: #b7bebf; border: solid 1px #b6bdbf; } input[type=checkbox] + label:before { border-radius: 2px; } .thf-grid-show-more { width: 100%; margin-top: 10px; margin-bottom: 10px; } "]}]}],e.ctorParameters=function(){return[{type:ViewContainerRef},{type:Renderer2}]},e.propDecorators={columns:[{type:Input,args:["t-columns"]}],sortable:[{type:Input,args:["t-sortable"]}],selectable:[{type:Input,args:["t-selectable"]}],editable:[{type:Input,args:["t-editable"]}],groupable:[{type:Input,args:["t-groupable"]}],exportButtons:[{type:Input,args:["t-show-export-buttons"]}],showMoreDisabled:[{type:Input,args:["t-show-more-disabled"]}],showRemoveButton:[{type:Input,args:["t-show-remove-button"]}],addButton:[{type:Input,args:["t-show-add-button"]}],saveAction:[{type:Input,args:["t-save-action"]}],removeAction:[{type:Input,args:["t-remove-action"]}],addAction:[{type:Input,args:["t-add-action"]}],showMore:[{type:Output,args:["t-show-more"]}],selectionChange:[{type:Output,args:["t-selection-change"]}],saveValue:[{type:Output,args:["t-save-value"]}],grid:[{type:ViewChild,args:[GridComponent]}]},e}(ThfGridBaseComponent);export{ThfGridComponent};function ThfGridComponent_tsickle_Closure_declarations(){ThfGridComponent.decorators,ThfGridComponent.ctorParameters,ThfGridComponent.propDecorators,ThfGridComponent.prototype.columns,ThfGridComponent.prototype.sortable,ThfGridComponent.prototype.selectable,ThfGridComponent.prototype.editable,ThfGridComponent.prototype.groupable,ThfGridComponent.prototype.exportButtons,ThfGridComponent.prototype.showMoreDisabled,ThfGridComponent.prototype.showRemoveButton,ThfGridComponent.prototype.addButton,ThfGridComponent.prototype.saveAction,ThfGridComponent.prototype.removeAction,ThfGridComponent.prototype.addAction,ThfGridComponent.prototype.showMore,ThfGridComponent.prototype.selectionChange,ThfGridComponent.prototype.saveValue,ThfGridComponent.prototype._parentRef,ThfGridComponent.prototype.editedRowIndex,ThfGridComponent.prototype.editedProducted,ThfGridComponent.prototype.groups,ThfGridComponent.prototype.gridView,ThfGridComponent.prototype.state,ThfGridComponent.prototype.sortableObject,ThfGridComponent.prototype.sort,ThfGridComponent.prototype.addButtonCalled,ThfGridComponent.prototype.isCancelling,ThfGridComponent.prototype.formGroup,ThfGridComponent.prototype.dataArrayOrdered,ThfGridComponent.prototype.grid,ThfGridComponent.prototype.viewRef,ThfGridComponent.prototype.renderer}